<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            height: 100%;
            margin: 0;
            max-width: 100%;
            padding-left: 0;
            padding-right: 0;
        }

        .dropdown-container {
            display: flex;
            flex-direction: column;
            border-radius: 2px;
        }

        select {
            font-size: 14px;
            /* padding: 10px; */
            width: 270px;
            height: 40px;
            display: flex;
            border-radius: 2px;
        }

        .status-container {
            font-size: 14px;
            height: 20px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .image-container {
            width: 1000px;
            height: 650px;
            display: flex;
            flex-direction: column;
            overflow: auto;
            margin: 0;
            padding: 0;
        }

        #processedImage {
            display: none;
            max-width: none;
            max-height: none;
            object-fit: contain;
        }

        .button-container {
            display: flex;
            justify-content: left;
            gap: 40px;
            margin-top: 20px;
            margin-left: 20px;
            width: min-content;
        }

        /* Style for all buttons */
        .button-container button {
            width: 80px;
            height: 40px;
            border-radius: 2px;
            border: none;
            cursor: pointer;
        }

        /* First container's buttons: Refresh and Load */
        .button-container:nth-child(1) button {
            background-color: #2372cc;
            color: white;
        }

        .button-container:nth-child(1) button:hover {
            background-color: #3696ff;
        }

        .button-container:nth-child(1) button:nth-child(2) {
            background-color: #218838;
            color: white;
        }

        .button-container:nth-child(1) button:nth-child(2):hover {
            background-color: #34d058;
        }

        /* Second container's buttons: Run and Reset */
        .button-container:nth-child(2) button:nth-child(1) {
            background-color: #2372cc;
            color: white;
        }

        .button-container:nth-child(2) button:nth-child(1):hover {
            background-color: #3696ff;
        }

        .button-container:nth-child(2) button:nth-child(2) {
            background-color: #ca2715;
            color: white;
        }

        .button-container:nth-child(2) button:nth-child(2):hover {
            background-color: #ff4c47;
        }
        
        /* Make each <p> for the information data a flex container for label and data alignment */
        .status-info p {
            display: flex;
            justify-content: space-between; /* Distribute the label and data across the width */
            align-items: center; /* Vertically center both the label and the data */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dropdown-container">
            <div style="display: flex; gap: 30px;">
                <!-- test duration -->
                <div class="box-container no-border-background">
                    <h2>Lower Ethernet port on Board</h2>
                    <p>Select test duration</p>
                    <select id="durationDropdown_LwEthOnb" onfocus="populateDropdownLwEthOnb()" onchange="clearLwEthOnbStatusNet()"></select>
                    <div class="status-container">
                        <p id="statusNet_LwEthOnb">&nbsp;</p>
                    </div>
                </div>
                <!-- results -->
                <div class="box-container no-border-background">
                    <h2>Test Results</h2>
                    <div style="display: flex; gap: 10px;">
                        <!-- Labels column -->
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <p><strong>Up Bandwidth:</strong></p>
                            <p><strong>Up Latency:</strong></p>
                            <p><strong>Up Lost/Total:</strong></p>
                            <p><strong>Down Bandwidth:</strong></p>
                            <p><strong>Down Latency:</strong></p>
                            <p><strong>Down Lost/Total:</strong></p>
                        </div>
                        <!-- Values column -->
                        <div style="display: flex; flex-direction: column; width: 150px; align-items: flex-start;">                            <p><span id="upBW_LwEthOnb">N/A</span></p>
                            <p><span id="upLat_LwEthOnb">N/A</span></p>
                            <p><span id="upLostTotal_LwEthOnb">N/A</span></p>
                            <p><span id="downBW_LwEthOnb">N/A</span></p>
                            <p><span id="downLat_LwEthOnb">N/A</span></p>
                            <p><span id="downLostTotal_LwEthOnb">N/A</span></p>
                        </div>
                    </div>
                </div>
                <!-- buttons -->
                <div class="box-container no-border-background">
                    <div class="button-container">
                        <button onclick="btnLwEthOnbRunClick()">Run</button>
                        <button onclick="btnLwEthOnbResetClick()">Reset</button>
                    </div>
                </div>
            </div>


            <div style="display: flex; gap: 30px;">
                <!-- test duration -->
                <div class="box-container no-border-background">
                    <h2>Lower Ethernet port on NIC</h2>
                    <p>Select test duration</p>
                    <select id="durationDropdown_LwEthAdt" onfocus="populateDropdownLwEthAdt()" onchange="clearLwEthAdtStatusNet()"></select>
                    <div class="status-container">
                        <p id="statusNet_LwEthAdt">&nbsp;</p>
                    </div>
                </div>
                <!-- results -->
                <div class="box-container no-border-background">
                    <h2>Test Results</h2>
                    <div style="display: flex; gap: 10px;">
                        <!-- Labels column -->
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <p><strong>Up Bandwidth:</strong></p>
                            <p><strong>Up Latency:</strong></p>
                            <p><strong>Up Lost/Total:</strong></p>
                            <p><strong>Down Bandwidth:</strong></p>
                            <p><strong>Down Latency:</strong></p>
                            <p><strong>Down Lost/Total:</strong></p>
                        </div>
                        <!-- Values column -->
                        <div style="display: flex; flex-direction: column; width: 200px; align-items: flex-start;">
                            <p><span id="upBW_LwEthAdt">N/A</span></p>
                            <p><span id="upLat_LwEthAdt">N/A</span></p>
                            <p><span id="upLostTotal_LwEthAdt">N/A</span></p>
                            <p><span id="downBW_LwEthAdt">N/A</span></p>
                            <p><span id="downLat_LwEthAdt">N/A</span></p>
                            <p><span id="downLostTotal_LwEthAdt">N/A</span></p>
                        </div>
                    </div>
                </div>
                <!-- buttons -->            
                <div class="box-container no-border-background">
                    <div class="button-container">
                        <button onclick="btnLwEthAdtRunClick()">Run</button>
                        <button onclick="btnLwEthAdtResetClick()">Reset</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let testDurationLwEthOnb = null; // Variable to store selected duration
        let testDurationLwEthAdt = null;
        
        async function btnLwEthOnbRunClick() {
            const selectedTestDuration = testDurationLwEthOnb; // Use the global testDuration variable
            const statusNetElement = document.getElementById("statusNet_LwEthOnb");

            document.getElementById("upBW_LwEthOnb").textContent = "N/A";
            document.getElementById("upLat_LwEthOnb").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthOnb").textContent = "N/A";
            document.getElementById("downBW_LwEthOnb").textContent = "N/A";
            document.getElementById("downLat_LwEthOnb").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthOnb").textContent = "N/A";

            if (!selectedTestDuration) {
                statusNetElement.textContent = "Please select a duration first";
                return;
            }
            // Send the NETRUN message via POST request
            await fetch("http://localhost:5000/send_message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: `NETRUN:${selectedTestDuration}:LwEthOnb` })
            });
            statusNetElement.textContent = "Waiting for results...";
            
            await new Promise(resolve => setTimeout(resolve, testDurationLwEthOnb*1000*2+2000));

            fetch('http://localhost:5000/iperf3/lw_eth_onb_results')
                .then(response => response.json())
                .then(data => {
                    // Extract the relevant data from the JSON response
                    stream = data.down.sum;

                    // Convert bits_per_second to Mbit/sec (divide by 1e6)
                    bitsPerSecondMbit = stream.bits_per_second / 1e6;
                    jitterMs = stream.jitter_ms;
                    lostPackets = stream.lost_packets;
                    totalPackets = stream.packets;
                    lostPercent = stream.lost_percent;

                    // Function to format the lostPercent to 2 non-zero decimal points
                    function formatLostPercent(percent) {
                        // Round the number to 2 non-zero digits after the decimal
                        return parseFloat(percent.toFixed(4)); // This keeps 2 decimal digits, removing unnecessary zeros
                    }

                    document.getElementById('downBW_LwEthOnb').textContent = `${bitsPerSecondMbit.toFixed(2)} Mbit/sec`;
                    document.getElementById('downLat_LwEthOnb').textContent = `${jitterMs.toFixed(4)} ms`;
                    document.getElementById('downLostTotal_LwEthOnb').textContent = `${lostPackets}/${totalPackets} (${formatLostPercent(lostPercent)}%)`;
                    
                    stream = data.up.sum;

                    // Convert bits_per_second to Mbit/sec (divide by 1e6)
                    bitsPerSecondMbit = stream.bits_per_second / 1e6;
                    jitterMs = stream.jitter_ms;
                    lostPackets = stream.lost_packets;
                    totalPackets = stream.packets;
                    lostPercent = stream.lost_percent;

                    // Function to format the lostPercent to 2 non-zero decimal points
                    function formatLostPercent(percent) {
                        // Round the number to 2 non-zero digits after the decimal
                        return parseFloat(percent.toFixed(4)); // This keeps 2 decimal digits, removing unnecessary zeros
                    }

                    // Display the extracted information on the page
                    document.getElementById('upBW_LwEthOnb').textContent = `${bitsPerSecondMbit.toFixed(2)} Mbit/sec`;
                    document.getElementById('upLat_LwEthOnb').textContent = `${jitterMs.toFixed(4)} ms`;
                    document.getElementById('upLostTotal_LwEthOnb').textContent = `${lostPackets}/${totalPackets} (${formatLostPercent(lostPercent)}%)`;
         
                    statusNetElement.textContent = "Waiting for results... Done";
                })
                .catch(error => {
                    statusNetElement.textContent = "Test run error";
                    console.error('Error fetching the data:', error);
                });
        }
        
        function btnLwEthOnbResetClick() {
            testDurationLwEthOnb = null;
            document.getElementById("durationDropdown_LwEthOnb").innerHTML = '<option value="" disabled selected>Select Duration</option>';
            document.getElementById("statusNet_LwEthOnb").textContent = "";
            document.getElementById("upBW_LwEthOnb").textContent = "N/A";
            document.getElementById("upLat_LwEthOnb").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthOnb").textContent = "N/A";
            document.getElementById("downBW_LwEthOnb").textContent = "N/A";
            document.getElementById("downLat_LwEthOnb").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthOnb").textContent = "N/A";
        }

        async function btnLwEthAdtRunClick() {
            const selectedTestDuration = testDurationLwEthAdt; // Use the global testDuration variable
            const statusNetElement = document.getElementById("statusNet_LwEthAdt");

            document.getElementById("upBW_LwEthAdt").textContent = "N/A";
            document.getElementById("upLat_LwEthAdt").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthAdt").textContent = "N/A";
            document.getElementById("downBW_LwEthAdt").textContent = "N/A";
            document.getElementById("downLat_LwEthAdt").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthAdt").textContent = "N/A";

            if (!selectedTestDuration) {
                statusNetElement.textContent = "Please select a duration first";
                return;
            }
            // Send the NETRUN message via POST request
            await fetch("http://localhost:5000/send_message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: `NETRUN:${selectedTestDuration}:LwEthAdt` })
            });
            statusNetElement.textContent = "Waiting for results...";
            
            await new Promise(resolve => setTimeout(resolve, testDurationLwEthAdt*1000*2+2000));

            fetch('http://localhost:5000/iperf3/lw_eth_adt_results')
                .then(response => response.json())
                .then(data => {
                    // Extract the relevant data from the JSON response
                    stream = data.data.down.sum_sent;

                    // Convert bits_per_second to Mbit/sec (divide by 1e6)
                    bitsPerSecondMbit = stream.bits_per_second / 1e6;
                    // jitterMs = stream.jitter_ms;
                    // lostPackets = stream.lost_packets;
                    // totalPackets = stream.packets;
                    // lostPercent = stream.lost_percent;

                    // Function to format the lostPercent to 2 non-zero decimal points
                    function formatLostPercent(percent) {
                        // Round the number to 2 non-zero digits after the decimal
                        return parseFloat(percent.toFixed(4)); // This keeps 2 decimal digits, removing unnecessary zeros
                    }

                    document.getElementById('downBW_LwEthAdt').textContent = `${bitsPerSecondMbit.toFixed(2)} Mbit/sec`;
                    // document.getElementById('downLat_LwEthAdt').textContent = `${jitterMs.toFixed(4)} ms`;
                    // document.getElementById('downLostTotal_LwEthAdt').textContent = `${lostPackets}/${totalPackets} (${formatLostPercent(lostPercent)}%)`;
                    
                    stream = data.data.up.sum_sent;

                    // Convert bits_per_second to Mbit/sec (divide by 1e6)
                    bitsPerSecondMbit = stream.bits_per_second / 1e6;
                    // jitterMs = stream.jitter_ms;
                    // lostPackets = stream.lost_packets;
                    // totalPackets = stream.packets;
                    // lostPercent = stream.lost_percent;

                    // Function to format the lostPercent to 2 non-zero decimal points
                    function formatLostPercent(percent) {
                        // Round the number to 2 non-zero digits after the decimal
                        return parseFloat(percent.toFixed(4)); // This keeps 2 decimal digits, removing unnecessary zeros
                    }

                    // Display the extracted information on the page
                    document.getElementById('upBW_LwEthAdt').textContent = `${bitsPerSecondMbit.toFixed(2)} Mbit/sec`;
                    // document.getElementById('upLat_LwEthAdt').textContent = `${jitterMs.toFixed(4)} ms`;
                    // document.getElementById('upLostTotal_LwEthAdt').textContent = `${lostPackets}/${totalPackets} (${formatLostPercent(lostPercent)}%)`;
         
                    statusNetElement.textContent = "Waiting for results... Done";
                })
                .catch(error => {
                    statusNetElement.textContent = "Test run error";
                    console.error('Error fetching the data:', error);
                });        
        }

        function btnLwEthAdtResetClick() {
            testDurationLwEthAdt = null;
            document.getElementById("durationDropdown_LwEthAdt").innerHTML = '<option value="" disabled selected>Select Duration</option>';
            document.getElementById("statusNet_LwEthAdt").textContent = "";
            document.getElementById("upBW_LwEthAdt").textContent = "N/A";
            document.getElementById("upLat_LwEthAdt").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthAdt").textContent = "N/A";
            document.getElementById("downBW_LwEthAdt").textContent = "N/A";
            document.getElementById("downLat_LwEthAdt").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthAdt").textContent = "N/A";
        }

        // Function to populate the dropdown for the lower ethernet port on the board
        function populateDropdownLwEthOnb() {
            document.getElementById("statusNet_LwEthOnb").textContent = "";

            let dropdown = document.getElementById("durationDropdown_LwEthOnb");
            dropdown.innerHTML = ""; // Clear existing options

            let defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Select Duration";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            dropdown.appendChild(defaultOption);

            for (let i = 5; i <= 60; i += 5) {
                let option = document.createElement("option");
                option.value = i; // Store only the numeric value
                option.textContent = `${i} seconds`;
                dropdown.appendChild(option);
            }
        }

        // Function to populate the dropdown for the lower ethernet port of the adapter
        function populateDropdownLwEthAdt() {
            document.getElementById("statusNet_LwEthAdt").textContent = "";

            let dropdown = document.getElementById("durationDropdown_LwEthAdt");
            dropdown.innerHTML = ""; // Clear existing options

            let defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Select Duration";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            dropdown.appendChild(defaultOption);

            for (let i = 5; i <= 60; i += 5) {
                let option = document.createElement("option");
                option.value = i; // Store only the numeric value
                option.textContent = `${i} seconds`;
                dropdown.appendChild(option);
            }
        }

        // Function to handle the change in the dropdown value
        function clearLwEthOnbStatusNet() {
            document.getElementById("statusNet_LwEthOnb").textContent = "";
            document.getElementById("upBW_LwEthOnb").textContent = "N/A";
            document.getElementById("upLat_LwEthOnb").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthOnb").textContent = "N/A";
            document.getElementById("downBW_LwEthOnb").textContent = "N/A";
            document.getElementById("downLat_LwEthOnb").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthOnb").textContent = "N/A";

            const dropdown = document.getElementById("durationDropdown_LwEthOnb");
            testDurationLwEthOnb = parseInt(dropdown.value, 10);
        }


        // Function to handle the change in the dropdown value
        function clearLwEthAdtStatusNet() {
            document.getElementById("statusNet_LwEthAdt").textContent = "";
            document.getElementById("upBW_LwEthAdt").textContent = "N/A";
            document.getElementById("upLat_LwEthAdt").textContent = "N/A";
            document.getElementById("upLostTotal_LwEthAdt").textContent = "N/A";
            document.getElementById("downBW_LwEthAdt").textContent = "N/A";
            document.getElementById("downLat_LwEthAdt").textContent = "N/A";
            document.getElementById("downLostTotal_LwEthAdt").textContent = "N/A";

            const dropdown = document.getElementById("durationDropdown_LwEthAdt");
            testDurationLwEthAdt = parseInt(dropdown.value, 10);
        }
    </script>
</body>
</html>
